name: Deploy OpenEMR to On-Prem K8s

on:
  push:
    branches: [main]
    paths:
      - 'deployment/**'
      - '.github/workflows/deploy-to-k8s.yml'
  workflow_dispatch:

env:
  REGISTRY_URL: localhost:5000
  NAMESPACE: openemr

jobs:
  deploy:
    runs-on: [self-hosted, on-prem, linux, openemr]
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_CONTENT }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          echo "✓ Kubeconfig loaded"

      - name: Verify kubectl access
        run: |
          kubectl cluster-info
          kubectl get nodes
          echo "✓ Kubectl access verified"

      - name: Create namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          echo "✓ Namespace ready"

      - name: Apply storage claims
        run: |
          kubectl apply -f deployment/storage-claim.yaml
          echo "✓ Storage claims applied"
          kubectl get pvc -n ${{ env.NAMESPACE }}

      - name: Create .env from secrets
        run: |
          cat > deployment/.env <<EOF
          COMPOSE_PROJECT_NAME=openemr
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_USER=${{ secrets.MYSQL_USER }}
          MYSQL_PASS=${{ secrets.MYSQL_PASS }}
          OE_USER=${{ secrets.OE_USER }}
          OE_PASS=${{ secrets.OE_PASS }}
          COUCHDB_USER=${{ secrets.COUCHDB_USER }}
          COUCHDB_PASS=${{ secrets.COUCHDB_PASS }}
          MAILPIT_PASSWORD=${{ secrets.MAILPIT_PASSWORD }}
          SE_VNC_PASSWORD=${{ secrets.SE_VNC_PASSWORD }}
          EOF
          echo "✓ .env created from secrets"

      - name: Create k8s manifests directory
        run: |
          mkdir -p deployment/k8s-manifests
          rm -f deployment/k8s-manifests/*
          echo "✓ Manifests directory ready"

      - name: Convert docker-compose to K8s manifests
        run: |
          cd deployment
          kompose convert \
            -f docker-compose.yml \
            -o k8s-manifests/ \
            --push-image false \
            --build none
          echo "✓ Kompose conversion complete"
          ls -la k8s-manifests/

      - name: Update image references to registry
        run: |
          sed -i "s|image: \([^/]*\):|image: ${{ env.REGISTRY_URL }}/\1:|g" deployment/k8s-manifests/*.yaml
          echo "✓ Updated image references:"
          grep "image:" deployment/k8s-manifests/*.yaml | head -20

      - name: Apply K8s manifests
        run: |
          kubectl apply -f deployment/k8s-manifests/ -n ${{ env.NAMESPACE }}
          echo "✓ Manifests applied to K8s"

      - name: Wait for deployments to rollout
        run: |
          echo "Waiting for MySQL..."
          kubectl rollout status deployment/mysql -n ${{ env.NAMESPACE }} --timeout=10m || true
          echo ""
          echo "Waiting for OpenEMR..."
          kubectl rollout status deployment/openemr -n ${{ env.NAMESPACE }} --timeout=10m || true
          echo ""
          echo "Waiting for CouchDB..."
          kubectl rollout status deployment/couchdb -n ${{ env.NAMESPACE }} --timeout=10m || true

      - name: Get deployment status
        if: always()
        run: |
          echo "=== Deployments ==="
          kubectl get deployments -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Services ==="
          kubectl get svc -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== PVCs ==="
          kubectl get pvc -n ${{ env.NAMESPACE }}

      - name: Check pod logs if deployment failed
        if: failure()
        run: |
          echo "=== MySQL Logs ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app=mysql --tail=100 || true
          echo ""
          echo "=== OpenEMR Logs ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app=openemr --tail=100 || true

      - name: Show access info
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo ""
          echo "Access OpenEMR with port-forward:"
          echo "kubectl port-forward -n ${{ env.NAMESPACE }} svc/openemr 8080:80 &"
          echo "Then visit: http://localhost:8080"